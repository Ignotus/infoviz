Map=function(h){L.mapbox.accessToken="pk.eyJ1IjoieGlhb2xpIiwiYSI6IkhpWkZhZFkifQ.RgWs4kq33jfD3d46_TTd6g";this.map=L.mapbox.map("map","examples.map-i86nkdio").setView([52.3648367,4.9151507],13);var d=0,l=[],k={},m={};this.starPlotData={};this.markers=[];var r="rgb(225,151,76) rgb(132,186,91) rgb(211,94,96) rgb(128,133,133) rgb(144,103,167) rgb(171,104,87) rgb(204,194,16)".split(" "),e=[],n=[],t=[],u=new Rainbow,b=this,x=function(){b.markers.forEach(function(a){b.map.removeLayer(a)});b.markers=[]};this.reselect=
function(){for(var a=0;a<l.length;++a)k[l[a]].setStyle({fillColor:r[e[a]]})};var y=function(a,c){n.push(b.starPlotData[a]);t.push(a);h.plotRegionStat([b.starPlotData[a]],a,"chart"+a,c[0]);0<n.length&&v()},v=function(){d3.select(".hist").select(".chartBig").remove();h.plotRegionStat(n,t,"chartBig",e);d3.select(".hist").select(".chartBig").style("text-align","center")};this.drawRegions=function(){ajax("/data/regions",function(a){var c={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5};
a.forEach(function(a){var f='<center><font size="3"><b>'+a.region+"</b></font></center><b>Region area</b>: "+a.area+" m^2<br /><b>Average price</b>: "+a.avgPrice+" EUR <br /><b>Average price per m^2</b>: "+a.avgPricePerSquareMeter+" EUR <br /><b>Average surface area</b>: "+a.avgSurfaceArea+' m^2<br /><a href="http://www.funda.nl/koop/amsterdam/'+a.region+'/"><center>Find a house</center></a>',f=L.polygon(a.border).bindPopup(f).setStyle(c).addTo(b.map);k[a.region]=f;m[a.region]=c;b.clickedRegions=
[];f.on("click",function(c){d=a.region;var p=l.indexOf(d);if(0<=p)l.splice(p,1),n.splice(p,1),t.splice(p,1),e.splice(p,1),d3.select(".hist").select(".chart"+d).remove(),k[d].setStyle(m[d]),d=0,0<n.length?v():d3.select(".hist").select(".chartBig").remove();else if(!(2<e.length)){var g,q;for(q in r)if(-1===e.indexOf(q)){g=q;break}e.push(g);l.push(d);c.target.setStyle({fillColor:r[g]});a.region in b.starPlotData&&(b.starPlotData={});var w={};h.layerType.forEach(function(b){w[b]=a[b]});b.starPlotData[a.region]=
w;y(a.region,q)}})})})};this.showMapStat=function(a,c){c="undefined"!==typeof c?c:null;$("span#layer-caption").html(h.layerCaptions[a]);x();if(a==h.layerID.region){var d={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5},f;for(f in k)k[f].setStyle(d),m[f]=d;b.reselect()}else{var e={};c&&c.forEach(function(a){e[a]=!0});ajax("/data/regions",function(d){var g=new L.MarkerClusterGroup;d.forEach(function(b){null!=c&&1!=e[b.region]||ajax("/data/objects/by_region/"+b.region+"/by_type/"+h.layerType[a],
function(a){a.forEach(function(a){L.marker(a.coordinate).bindPopup(a.name+"<br/>"+a.subtype).addTo(g)})})});g.addTo(b.map);b.markers.push(g)});ajax("/data/regions/stat",function(c){var d=0;c.forEach(function(b){d=Math.max(b.place_frequencies[a].value,d)});u.setNumberRange(0,d);u.setSpectrum("lightgreen","darkgreen");var e={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.1,fillOpacity:.2};c.forEach(function(b){var d=k[b.region];if(1E-4<b.place_frequencies[a].value){var c="#"+u.colourAt(b.place_frequencies[a].value),
c={fillColor:c,color:c,fillOpacity:.5,opacity:.5};d.setStyle(c);m[b.region]=c}else d.setStyle(e),m[b.region]=e});b.reselect()})}}};
