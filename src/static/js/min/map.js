Map=function(e){L.mapbox.accessToken="pk.eyJ1IjoieGlhb2xpIiwiYSI6IkhpWkZhZFkifQ.RgWs4kq33jfD3d46_TTd6g";this.map=L.mapbox.map("map","examples.map-i86nkdio",{maxZoom:17,minZoom:11}).setView([52.37,4.895518],12);this.map.addControl(L.mapbox.geocoderControl("mapbox.places"));this.map.doubleClickZoom.disable();var f=0,m=[],l={},n={};this.starPlotData={};this.markers=[];var g=[],p=[],r=[],t=new Rainbow,c=this,u=!0,x=function(){c.markers.forEach(function(a){c.map.removeLayer(a)});c.markers=[]};this.reselect=
function(){for(var a=0;a<m.length;++a)l[m[a]].setStyle({fillColor:e.colours[g[a]]})};var y=function(a,b){p.push(c.starPlotData[a]);r.push(a);e.plotRegionStat([c.starPlotData[a]],a,"chart"+a,b[0]);0<p.length&&v()},v=function(){d3.select(".bigPlot").select(".chartBig").remove();e.plotRegionStat(p,r,"chartBig",g)};this.showPopup=function(a){l[a].openPopup()};this.drawRegions=function(){ajax("/data/regions",function(a){var b={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5};a.forEach(function(a){var h=
'<center><font size="3"><b>'+a.region+"</b></font></center><b>Region area</b>: "+formatNum(a.area)+" m<sup>2</sup><br /><b>Average price</b>: "+formatNum(a.avgPrice)+" EUR <br /><b>Average price per m<sup>2</sup></b>: "+formatNum(a.avgPricePerSquareMeter)+" EUR <br /><b>Average surface area</b>: "+formatNum(a.avgSurfaceArea)+' m<sup>2</sup><br /><a href="http://www.funda.nl/koop/amsterdam/'+a.region+'/" target="_blank"><center><img src="http://png-5.findicons.com/files/icons/1686/led/16/house.png"> Find a house</center></a>',
h=L.polygon(a.border).bindPopup(h).setStyle(b).addTo(c.map);l[a.region]=h;n[a.region]=b;c.clickedRegions=[];h.on("click",function(b){u&&(u=!1,$(".board").animate({"margin-right":"+=500"}),$(".myCarousel").hide());f=a.region;b.target.closePopup();var k=m.indexOf(f);if(0<=k)m.splice(k,1),p.splice(k,1),r.splice(k,1),g.splice(k,1),d3.select(".starPlots").select(".chart"+f).remove(),b.target.setStyle(n[f]),f=0,0<p.length?v():d3.select(".bigPlot").select(".chartBig").remove();else if(!(4<=g.length)){var d,
q;for(q in e.colours)if(-1===g.indexOf(q)){d=q;break}g.push(d);m.push(f);b.target.setStyle({fillColor:e.colours[d]});a.region in c.starPlotData&&(c.starPlotData={});var w={};e.layerType.forEach(function(b){w[b]=a[b]});c.starPlotData[a.region]=w;y(a.region,q)}})})})};formatNum=function(a){a=(""+a).replace(".",",");return(""+a).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,function(a){return a+"."})};this.showMapStat=function(a,b){b="undefined"!==typeof b?b:null;$("span#layer-caption").html(e.layerCaptions[a]);
x();if(a==e.layerID.region){var f={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5},h;for(h in l)l[h].setStyle(f),n[h]=f;c.reselect()}else{var g={};b&&b.forEach(function(a){g[a]=!0});ajax("/data/regions",function(k){var d=new L.MarkerClusterGroup;k.forEach(function(c){null!=b&&1!=g[c.region]||ajax("/data/objects/by_region/"+c.region+"/by_type/"+e.layerType[a],function(a){a.forEach(function(a){L.marker(a.coordinate).bindPopup(a.name+"<br/>"+a.subtype).addTo(d)})})});d.addTo(c.map);c.markers.push(d)});
ajax("/data/regions/stat",function(b){var d=0;b.forEach(function(b){d=Math.max(b.place_frequencies[a].value,d)});t.setNumberRange(0,d);t.setSpectrum("lightgreen","darkgreen");var e={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.1,fillOpacity:.2};b.forEach(function(b){var c=l[b.region];if(1E-4<b.place_frequencies[a].value){var d="#"+t.colourAt(b.place_frequencies[a].value),d={fillColor:d,color:d,fillOpacity:.5,opacity:.5};c.setStyle(d);n[b.region]=d}else c.setStyle(e),n[b.region]=e});c.reselect()})}}};
