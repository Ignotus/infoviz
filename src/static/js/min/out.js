Core=function(){this.layerType=["green","sport"];this.layerID={region:-1,green:0,sport:1};this.layerCaptions={};this.layerCaptions[this.layerID.region]="Regions";var c=this;this.plotRegionStat=function(e,b,g,k){var a={top:60,right:50,bottom:20,left:50},l=!0,d=200-a.left-a.right,q=400-a.left-a.right,n=200-a.top-a.bottom,f=400-a.top-a.bottom,h="rgb(225,151,76) rgb(132,186,91) rgb(211,94,96) rgb(128,133,133) rgb(144,103,167) rgb(171,104,87) rgb(204,194,16)".split(" ");d3.scale.linear().domain([0,100]).range([0,
100]);var t=d3.scale.linear().domain([0,100]).range([0,100]),u=d3.scale.linear().domain([0,100]).range([0,100]),w=d3.scale.linear().domain([0,100]).range([0,100]),z=d3.scale.linear().domain([0,100]).range([0,100]),m=d3.scale.linear().domain([0,100]).range([0,100]),C=d3.scale.linear().domain([0,100]).range([0,100]),B=d3.scale.linear().domain([0,100]).range([0,100]),v=d3.scale.linear().domain([0,100]).range([0,100]),t={activity:t,culinary:u,cultural:w,green:z,nonleisure:m,relaxation:C,spiritual:B,sport:v},
u=[],A;for(A in k)u.push(h[k[A]]);"chartBig"===g&&(d=q,n=f,l=!1);var p=d3.select(".hist").append("svg").attr("class",g).attr("width",d+a.left+a.right).attr("height",n+a.top+a.bottom);e=starPlot().width(d).propertiesList(e).scales(t).colours(u).title(b).margin(a).labelMargin(20);p.append("g").call(e);if(l)p.selectAll(".star-interaction").on("mouseover",function(a){p.selectAll(".star-label").style("display","none");p.append("circle").attr("class","interaction-circle").attr("r",4).attr("cx",a.x).attr("cy",
a.y).attr("fill","gray");p.append("text").attr("class","star-interaction-label").text(a.key+":  "+Math.round(10*a.value)/10).attr("x",a.textX).attr("y",a.textY)}).on("mouseout",function(a){p.selectAll(".star-label").style("display","");p.selectAll(".interaction-circle").remove();p.selectAll(".star-interaction-label").remove()}).on("click",function(a){c.showMapStatHandle(c.layerID[a.key],g.substr(5).split(","))})};this.setShowMapStatHandle=function(e){c.showMapStatHandle=e;ajax("/data/objects/types",
function(b){c.layerType=b;for(b=0;b<c.layerType.length;++b)c.layerID[c.layerType[b]]=b;c.layerType.forEach(function(b){c.layerCaptions[c.layerID[b]]=b;$(".dropdown-menu").html($(".dropdown-menu").html()+'<li><a href="#" id="'+b+'-layer-switcher">'+b+"</a></li>");$(".dropdown-menu").on("click","#"+b+"-layer-switcher",function(){$("span#layer-caption").html(b);e(c.layerID[b])})})});$(".dropdown-menu").on("click","#region-layer-switcher",function(){$("span#layer-caption").html("Regions");e(c.layerID.region)})}};
var core=new Core,map=new Map(core);core.setShowMapStatHandle(map.showMapStat);map.drawRegions();Map=function(c){L.mapbox.accessToken="pk.eyJ1IjoieGlhb2xpIiwiYSI6IkhpWkZhZFkifQ.RgWs4kq33jfD3d46_TTd6g";this.map=L.mapbox.map("map","examples.map-i86nkdio").setView([52.3648367,4.9151507],13);var e=0,b=[],g={},k={};this.starPlotData={};this.markers=[];var a="rgb(225,151,76) rgb(132,186,91) rgb(211,94,96) rgb(128,133,133) rgb(144,103,167) rgb(171,104,87) rgb(204,194,16)".split(" "),l=[],d=[],q=[],n=new Rainbow,f=this,h=function(){f.markers.forEach(function(a){f.map.removeLayer(a)});f.markers=[]};this.reselect=
function(){for(var d=0;d<b.length;++d)g[b[d]].setStyle({fillColor:a[l[d]]})};var t=function(a,b){d.push(f.starPlotData[a]);q.push(a);c.plotRegionStat([f.starPlotData[a]],a,"chart"+a,b[0]);0<d.length&&u()},u=function(){d3.select(".hist").select(".chartBig").remove();c.plotRegionStat(d,q,"chartBig",l);d3.select(".hist").select(".chartBig").style("text-align","center")};this.drawRegions=function(){ajax("/data/regions",function(w){var z={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5};
w.forEach(function(m){var w='<center><font size="3"><b>'+m.region+"</b></font></center><b>Region area</b>: "+m.area+" m^2<br /><b>Average price</b>: "+m.avgPrice+" EUR <br /><b>Average price per m^2</b>: "+m.avgPricePerSquareMeter+" EUR <br /><b>Average surface area</b>: "+m.avgSurfaceArea+' m^2<br /><a href="http://www.funda.nl/koop/amsterdam/'+m.region+'/"><center>Find a house</center></a>',w=L.polygon(m.border).bindPopup(w).setStyle(z).addTo(f.map);g[m.region]=w;k[m.region]=z;f.clickedRegions=
[];w.on("click",function(w){e=m.region;var z=b.indexOf(e);if(0<=z)b.splice(z,1),d.splice(z,1),q.splice(z,1),l.splice(z,1),d3.select(".hist").select(".chart"+e).remove(),g[e].setStyle(k[e]),e=0,0<d.length?u():d3.select(".hist").select(".chartBig").remove();else if(!(2<l.length)){var n,p;for(p in a)if(-1===l.indexOf(p)){n=p;break}l.push(n);b.push(e);w.target.setStyle({fillColor:a[n]});m.region in f.starPlotData&&(f.starPlotData={});var h={};c.layerType.forEach(function(a){h[a]=m[a]});f.starPlotData[m.region]=
h;t(m.region,p)}})})})};this.showMapStat=function(a,d){d="undefined"!==typeof d?d:null;$("span#layer-caption").html(c.layerCaptions[a]);h();if(a==c.layerID.region){var b={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.5,fillOpacity:.5},e;for(e in g)g[e].setStyle(b),k[e]=b;f.reselect()}else{var l={};d&&d.forEach(function(a){l[a]=!0});ajax("/data/regions",function(b){var e=new L.MarkerClusterGroup;b.forEach(function(b){null!=d&&1!=l[b.region]||ajax("/data/objects/by_region/"+b.region+"/by_type/"+c.layerType[a],
function(a){a.forEach(function(a){L.marker(a.coordinate).bindPopup(a.name+"<br/>"+a.subtype).addTo(e)})})});e.addTo(f.map);f.markers.push(e)});ajax("/data/regions/stat",function(d){var b=0;d.forEach(function(d){b=Math.max(d.place_frequencies[a].value,b)});n.setNumberRange(0,b);n.setSpectrum("lightgreen","darkgreen");var c={fillColor:"#66A3FF",color:"#2c7fb8",opacity:.1,fillOpacity:.2};d.forEach(function(d){var b=g[d.region];if(1E-4<d.place_frequencies[a].value){var e="#"+n.colourAt(d.place_frequencies[a].value),
e={fillColor:e,color:e,fillOpacity:.5,opacity:.5};b.setStyle(e);k[d.region]=e}else b.setStyle(c),k[d.region]=c});f.reselect()})}}};function Rainbow(){function c(a){if(2>a.length)throw Error("Rainbow must have two or more colours.");var c=(g-b)/(a.length-1),d=new ColourGradient;d.setGradient(a[0],a[1]);d.setNumberRange(b,b+c);e=[d];for(d=1;d<a.length-1;d++){var q=new ColourGradient;q.setGradient(a[d],a[d+1]);q.setNumberRange(b+c*d,b+c*(d+1));e[d]=q}k=a}var e=null,b=0,g=100,k=["ff0000","ffff00","00ff00","0000ff"];c(k);this.setSpectrum=function(){c(arguments);return this};this.setSpectrumByArray=function(a){c(a);return this};this.colorAt=
this.colourAt=function(a){if(isNaN(a))throw new TypeError(a+" is not a number");if(1===e.length)return e[0].colourAt(a);var c=(g-b)/e.length,c=Math.min(Math.floor((Math.max(a,b)-b)/c),e.length-1);return e[c].colourAt(a)};this.setNumberRange=function(a,e){if(e>a)b=a,g=e,c(k);else throw new RangeError("maxNumber ("+e+") is not greater than minNumber ("+a+")");return this}}
function ColourGradient(){function c(d,b,c){d<k&&(d=k);d>a&&(d=a);var e=a-k;b=parseInt(b,16);c=(parseInt(c,16)-b)/e;c=Math.round(c*(d-k)+b).toString(16);c=1===c.length?"0"+c:c;return c}function e(a){if(/^#?[0-9a-fA-F]{6}$/i.test(a))return a.substring(a.length-6,a.length);var b=a.toLowerCase();if(l.hasOwnProperty(b))return l[b];throw Error(a+" is not a valid colour.");}var b="ff0000",g="0000ff",k=0,a=100;this.setGradient=function(a,c){b=e(a);g=e(c)};this.setNumberRange=function(b,c){if(c>b)k=b,a=c;
else throw new RangeError("maxNumber ("+c+") is not greater than minNumber ("+b+")");};this.colourAt=function(a){return c(a,b.substring(0,2),g.substring(0,2))+c(a,b.substring(2,4),g.substring(2,4))+c(a,b.substring(4,6),g.substring(4,6))};var l={aliceblue:"F0F8FF",antiquewhite:"FAEBD7",aqua:"00FFFF",aquamarine:"7FFFD4",azure:"F0FFFF",beige:"F5F5DC",bisque:"FFE4C4",black:"000000",blanchedalmond:"FFEBCD",blue:"0000FF",blueviolet:"8A2BE2",brown:"A52A2A",burlywood:"DEB887",cadetblue:"5F9EA0",chartreuse:"7FFF00",
chocolate:"D2691E",coral:"FF7F50",cornflowerblue:"6495ED",cornsilk:"FFF8DC",crimson:"DC143C",cyan:"00FFFF",darkblue:"00008B",darkcyan:"008B8B",darkgoldenrod:"B8860B",darkgray:"A9A9A9",darkgreen:"006400",darkgrey:"A9A9A9",darkkhaki:"BDB76B",darkmagenta:"8B008B",darkolivegreen:"556B2F",darkorange:"FF8C00",darkorchid:"9932CC",darkred:"8B0000",darksalmon:"E9967A",darkseagreen:"8FBC8F",darkslateblue:"483D8B",darkslategray:"2F4F4F",darkslategrey:"2F4F4F",darkturquoise:"00CED1",darkviolet:"9400D3",deeppink:"FF1493",
deepskyblue:"00BFFF",dimgray:"696969",dimgrey:"696969",dodgerblue:"1E90FF",firebrick:"B22222",floralwhite:"FFFAF0",forestgreen:"228B22",fuchsia:"FF00FF",gainsboro:"DCDCDC",ghostwhite:"F8F8FF",gold:"FFD700",goldenrod:"DAA520",gray:"808080",green:"008000",greenyellow:"ADFF2F",grey:"808080",honeydew:"F0FFF0",hotpink:"FF69B4",indianred:"CD5C5C",indigo:"4B0082",ivory:"FFFFF0",khaki:"F0E68C",lavender:"E6E6FA",lavenderblush:"FFF0F5",lawngreen:"7CFC00",lemonchiffon:"FFFACD",lightblue:"ADD8E6",lightcoral:"F08080",
lightcyan:"E0FFFF",lightgoldenrodyellow:"FAFAD2",lightgray:"D3D3D3",lightgreen:"90EE90",lightgrey:"D3D3D3",lightpink:"FFB6C1",lightsalmon:"FFA07A",lightseagreen:"20B2AA",lightskyblue:"87CEFA",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"B0C4DE",lightyellow:"FFFFE0",lime:"00FF00",limegreen:"32CD32",linen:"FAF0E6",magenta:"FF00FF",maroon:"800000",mediumaquamarine:"66CDAA",mediumblue:"0000CD",mediumorchid:"BA55D3",mediumpurple:"9370DB",mediumseagreen:"3CB371",mediumslateblue:"7B68EE",
mediumspringgreen:"00FA9A",mediumturquoise:"48D1CC",mediumvioletred:"C71585",midnightblue:"191970",mintcream:"F5FFFA",mistyrose:"FFE4E1",moccasin:"FFE4B5",navajowhite:"FFDEAD",navy:"000080",oldlace:"FDF5E6",olive:"808000",olivedrab:"6B8E23",orange:"FFA500",orangered:"FF4500",orchid:"DA70D6",palegoldenrod:"EEE8AA",palegreen:"98FB98",paleturquoise:"AFEEEE",palevioletred:"DB7093",papayawhip:"FFEFD5",peachpuff:"FFDAB9",peru:"CD853F",pink:"FFC0CB",plum:"DDA0DD",powderblue:"B0E0E6",purple:"800080",red:"FF0000",
rosybrown:"BC8F8F",royalblue:"4169E1",saddlebrown:"8B4513",salmon:"FA8072",sandybrown:"F4A460",seagreen:"2E8B57",seashell:"FFF5EE",sienna:"A0522D",silver:"C0C0C0",skyblue:"87CEEB",slateblue:"6A5ACD",slategray:"708090",slategrey:"708090",snow:"FFFAFA",springgreen:"00FF7F",steelblue:"4682B4",tan:"D2B48C",teal:"008080",thistle:"D8BFD8",tomato:"FF6347",turquoise:"40E0D0",violet:"EE82EE",wheat:"F5DEB3",white:"FFFFFF",whitesmoke:"F5F5F5",yellow:"FFFF00",yellowgreen:"9ACD32"}};starPlot=function(){function c(b){n=b.attr("transform","translate("+g.left+","+g.top+")");r=0;for(var c in a[0])x=(f+k)*Math.cos(r),y=(f+k)*Math.sin(r),n.append("text").attr("class","star-label").attr("x",h[0]+x).attr("y",h[1]+y).text(c).style("text-anchor","middle").style("dominant-baseline","central"),r+=t;r=0;for(var m in a[0])x=f*Math.cos(r),y=f*Math.sin(r),n.append("line").attr("class","star-axis").attr("x1",h[0]).attr("y1",h[1]).attr("x2",h[0]+x).attr("y2",h[1]+y),r+=t;n.append("circle").attr("class",
"star-origin").attr("cx",h[0]).attr("cy",h[1]).attr("r",1);b=d3.svg.line.radial();r=Math.PI/2;for(c=0;c<a.length;c++){m=[];var C=a[c],B;for(B in C){var v=B.replace("-",""),v=[u((0,l[v])(C[B])),r];m.push(v);r+=t}n.append("path").attr("class","star-path").attr("transform","translate("+h[0]+","+h[1]+")").attr("d",b(m)+"Z").style("stroke",d[c]).style("fill",d[c])}n.append("text").attr("class","star-title").attr("x",h[0]).attr("y",-(g.top/2)).text(q).style("text-anchor","middle");e()}function e(){for(var c=
d3.svg.line.radial(),b=Math.PI/2,d=0,e=0;e<a.length;e++){var q=a[e],v;for(v in q){var A=f;Math.cos(b);Math.sin(b);var p=f+k,D=p*Math.cos(d)+h[0]+g.left,p=p*Math.sin(d)+h[1]+g.top,E=v.replace("-","");lValue=u((0,l[E])(q[v]));x=lValue*Math.cos(d)+h[0]+g.left;y=lValue*Math.sin(d)+h[1]+g.top;A=[[0,b-t/2],[A,b-t/2],[A,b+t/2]];Math.cos(d);Math.sin(d);D={textX:D,textY:p,x:x,y:y,key:v,value:q[v]};n.append("path").datum(D).attr("class","star-interaction").attr("transform","translate("+h[0]+","+h[1]+")").attr("d",
c(A)+"Z");b+=t;d+=t}}}var b=200,g={top:0,right:0,bottom:0,left:0},k=20,a={},l={},d=[],q="",n,f=b/2,h=[f,f],t,u=d3.scale.linear().domain([0,100]).range([0,f]);c.scales=function(a){if(!arguments.length)return l;a.constructor==Object&&(l=a);return c};c.width=function(a){if(!arguments.length)return b;b=a;f=b/2;h=[f,f];u.range([0,f]);return c};c.margin=function(a){if(!arguments.length)return g;g=a;h=[f,f];return c};c.labelMargin=function(a){if(!arguments.length)return k;k=a;return c};c.title=function(a){if(!arguments.length)return q;
q=a;return c};c.propertiesList=function(b){if(!arguments.length)return properties;a=b;t=2*Math.PI/Object.keys(a[0]).length;return c};c.colours=function(a){if(!arguments.length)return d;d=a;return c};c.interaction=function(){e()};return c};ajax=function(c,e){add_host=function(b){return document.domain?b:"http://root.org.ua"+b};$.ajax({url:add_host(c),dataType:"json",success:function(b){e(b.results)}})};
